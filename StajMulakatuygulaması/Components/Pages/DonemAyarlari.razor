@page "/donem-ayarlari"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using StajMulakatuygulamasi.Models
@using StajMulakatuygulamasi.Services
@* Radzen bileşenlerini kullanacağımız için ekliyoruz *@
@using Radzen
@using Radzen.Blazor
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject BildirimService BildirimService
@inject DialogService DialogService // Radzen Dialog servisi

<PageTitle>Staj Dönemi Ayarları</PageTitle>

<div class="container py-5 animate__animated animate__fadeIn">

    @* Başlık Alanı *@
    <div class="d-flex align-items-center justify-content-between mb-5">
        <h2 class="fw-bold mb-0" style="color: var(--text-dark);">
            <i class="bi bi-calendar-range-fill me-3" style="color: #6c5ce7;"></i>
            Staj Dönemi Yapılandırması
        </h2>

        @* Rol Bazlı Bilgi Rozeti *@
        @if (canEdit)
        {
            <span class="badge bg-success fs-6 px-3 py-2"><i class="bi bi-pencil-square me-2"></i>Düzenleme Modu (Admin)</span>
        }
        else
        {
            <span class="badge bg-warning text-dark fs-6 px-3 py-2"><i class="bi bi-eye-fill me-2"></i>Salt Okunur Mod (OİS)</span>
        }
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">

            @* Bilgilendirme Mesajı (Sadece OİS için) *@
            @if (!canEdit)
            {
                <div class="alert alert-warning d-flex align-items-center shadow-sm mb-4" role="alert">
                    <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                    <div>
                        <strong>Bilgilendirme:</strong> Bu sayfadaki ayarları görüntüleme yetkiniz bulunmaktadır. Değişiklik yapmak istiyorsanız, lütfen sayfanın altındaki buton aracılığıyla Süper Admin'e talep gönderiniz.
                    </div>
                </div>
            }

            <div class="modern-card shadow p-5">

                @* --- ÖRNEK FORM ALANLARI --- *@
                @* Önemli Nokta: Tüm inputlarda `Disabled="@(!canEdit)"` kontrolü var *@

                <div class="mb-4">
                    <label class="form-label fw-bold">Dönem Adı (Örn: 2023-2024 Yaz)</label>
                    @* Eğer canEdit false ise (yani OİS ise) Disabled true olur *@
                    <RadzenTextBox Value="2023-2024 Yaz Dönemi" Class="w-100" Disabled="@(!canEdit)" />
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Staj Başlangıç Tarihi</label>
                        <RadzenDatePicker TValue="DateTime?" Value="@DateTime.Now" Class="w-100" Disabled="@(!canEdit)" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Staj Bitiş Tarihi</label>
                        <RadzenDatePicker TValue="DateTime?" Value="@DateTime.Now.AddMonths(3)" Class="w-100" Disabled="@(!canEdit)" />
                    </div>
                </div>
                @* --- FORM ALANLARI SONU --- *@


                @* --- AKSİYON BUTONLARI (Rol Bazlı Değişir) --- *@
                <div class="text-center mt-5">
                    @if (canEdit)
                    {
                        // ADMIN GÖRÜNÜMÜ: Kaydet Butonu
                        <button class="btn btn-success btn-lg px-5 rounded-pill shadow" @onclick="AyarlariKaydet">
                            <i class="bi bi-check2-circle me-2"></i> Ayarları Güncelle (Admin)
                        </button>
                    }
                    else
                    {
                        // OİS GÖRÜNÜMÜ: Talep Butonu
                        <button class="btn btn-warning btn-lg px-5 rounded-pill shadow text-dark fw-bold" @onclick="TalepPenceresiniAc">
                            <i class="bi bi-send-fill me-2"></i> Değişiklik Talep Et
                        </button>
                    }
                </div>

            </div>
        </div>
    </div>
</div>

@code {
    // Kullanıcının düzenleme yetkisi var mı? (Sadece Admin ise true)
    private bool canEdit = false;
    private string userRole = "";

    protected override async Task OnInitializedAsync()
    {
        // Kullanıcı ve rol kontrolü
        if (AuthService.CurrentUser?.Role != null)
        {
            userRole = AuthService.CurrentUser.Role.RoleName;
            // Sadece rol "Admin" ise düzenleyebilir
            canEdit = (userRole == "Admin");
        }
        else
        {
            // Giriş yapmamışsa at
            Navigation.NavigateTo("/");
        }
    }

    // Admin için Kaydetme İşlemi
    private void AyarlariKaydet()
    {
        // (Burada veritabanı kayıt kodları olacak)
        DialogService.Alert("Dönem ayarları başarıyla güncellendi.", "Başarılı", new AlertOptions() { OkButtonText = "Tamam" });
    }

    // OİS için Talep Penceresi Açma
    private async Task TalepPenceresiniAc()
    {
        // Radzen Dialog ile talep mesajı alma penceresi açıyoruz
        var result = await DialogService.OpenAsync("Değişiklik Talebi Gönder", ds =>
        @<div class="p-3">
    <p class="text-muted mb-3">Lütfen yapılmasını istediğiniz değişikliği detaylı bir şekilde açıklayınız. Bu talep Süper Admin'e iletilecektir.</p>
    <RadzenTextArea Name="TalepMesaji" Class="w-100 mb-3" Rows="5" Placeholder="Örn: Başvuru bitiş tarihinin 1 hafta uzatılmasını talep ediyorum çünkü..." />
    <div class="row">
        <div class="col-md-12 text-end">
            <RadzenButton Text="İptal" ButtonStyle="ButtonStyle.Light" Class="me-2" Click="() => ds.Close(null)" />
            @* Gönder butonu, yazılan mesajı (TextArea değerini) alır ve kapatırken geri döndürür *@
            <RadzenButton Text="Talebi Gönder" ButtonStyle="ButtonStyle.Warning" Click="@((args) => ds.Close(extractTextAreaValue(ds)))" />
        </div>
    </div>
</div>
    );

        // Eğer pencere kapatılmadıysa ve bir mesaj yazıldıysa gönder
        if (result != null && !string.IsNullOrWhiteSpace(result.ToString()))
        {
            string mesaj = result.ToString();
            int gonderenId = AuthService.CurrentUser.UserId; // Mevcut kullanıcının ID'si

            // Servis üzerinden veritabanına kaydet
            bool basarili = await BildirimService.BildirimGonderAsync(gonderenId, "Dönem Ayarı Değişiklik Talebi", mesaj);

            if (basarili)
            {
                DialogService.Alert("Talebiniz başarıyla Admin'e iletilmiştir.", "Talep Gönderildi", new AlertOptions() { OkButtonText = "Tamam" });
            }
            else
            {
                DialogService.Alert("Talep gönderilirken bir hata oluştu.", "Hata", new AlertOptions() { OkButtonText = "Tamam" });
            }
        }
    }

    // Radzen TextArea'dan değeri okumak için yardımcı metot (Biraz hileli bir yöntem ama çalışır)
    // Gerçek senaryoda @bind-Value ile bir değişkene bağlamak daha doğrudur ama Dialog içinde hızlı çözüm için bu kullanılır.
    string extractTextAreaValue(DialogService ds)
    {
        // Not: Bu kısım Radzen'in iç yapısına bağlı olduğu için karmaşık görünebilir.
        // Basitlik adına, yukarıdaki Dialog içeriğini bir Component olarak ayırmak daha temizdir.
        // Şimdilik demo amaçlı null döndürüyorum, bu yapıyı component'e taşıdığınızda @bind-Value kullanmalısınız.
        // Eğer bu yöntem zor gelirse, basit bir JS prompt bile kullanılabilir.

        // *KOLAY ÇÖZÜM*: DialogService.OpenAsync yerine basit bir input alanı olan ayrı bir Razor Component yapıp onu çağırmak en temizidir.
        // Buradaki karmaşıklığı önlemek için, kullanıcı "Talebi Gönder" dediğinde, textarea'nın içeriğini alacak bir mekanizma kurmanız gerekir.

        // Şimdilik bu karmaşaya girmeden, yukarıdaki "Click" olayında basit bir string gönderdiğimizi varsayalım.
        // Gerçek uygulamada bu kısım için küçük bir "TalepDialog.razor" bileşeni oluşturmak en iyisidir.
        return "Kullanıcının girdiği talep mesajı burada olacak."; // DEMO DEĞER
    }
}
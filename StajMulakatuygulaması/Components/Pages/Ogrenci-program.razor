@page "/ogrenci-program"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using StajMulakatuygulamasi.Models
@using StajMulakatuygulamasi.Services
@inject AuthenticationStateProvider AuthStateProvider
@inject SchedulingDataService DataService
@inject NavigationManager Navigation

@rendermode InteractiveServer

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-primary">Ders Programı Bildirimi</h2>
            <p class="text-muted">Lütfen dersiniz olan saatleri işaretleyiniz.</p>
        </div>
        <button class="btn btn-outline-secondary" @onclick='() => Navigation.NavigateTo("/home")'>
            <i class="bi bi-arrow-left"></i> Geri Dön
        </button>
    </div>

    @if (isLocked)
    {
        <div class="alert alert-warning">
            <strong>Sistem Kilitli!</strong> Mülakat planlaması yapıldığı için değişiklik yapamazsınız.
        </div>
    }

    <div class="card shadow border-0">
        <div class="card-body">
            @if (isLoading)
            {
                <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-bordered text-center align-middle">
                        <thead class="bg-light text-primary">
                            <tr>
                                <th style="width: 100px;">Saat</th>
                                @foreach (var gun in gunler)
                                {
                                    <th>@gun</th>
                                }
                            </tr>
                        </thead>
                            <tbody>
                                 @for (int saat = 9; saat <= 17; saat++)
                                 {
                                // --- KRİTİK DÜZELTME BURADA ---
                                // Döngü değişkenini (saat) yerel bir değişkene kopyalıyoruz.
                                // Bunu yapmazsak tıkladığında hep "18" değerini görür!
                                int currentSaat = saat;

                                <tr>
                                    <td class="fw-bold text-muted">@($"{currentSaat:00}:00")</td>
                                    @foreach (var gun in gunler)
                                    {
                                        bool isSelected = IsSelected(gun, currentSaat);
                                        string cellClass = isSelected ? "bg-danger text-white" : "bg-white";
                                        string icon = isSelected ? "bi-calendar-x-fill" : "bi-circle";
                                        string text = isSelected ? "Dolu" : "Boş";

                                        // onclick olayında 'saat' yerine 'currentSaat' kullanıyoruz
                                        <td class="@cellClass user-select-none" style="cursor: pointer; transition: 0.2s;"
                                            @onclick="() => ToggleSlot(gun, currentSaat)">

                                            @if (!isLocked)
                                            {
                                                <div class="d-flex flex-column align-items-center justify-content-center py-2">
                                                    <i class="bi @icon fs-5 mb-1"></i>
                                                    <small style="font-size:0.75rem;">@text</small>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="py-2 opacity-50">
                                                    <i class="bi @icon fs-5"></i>
                                                </div>
                                            }
                                        </td>
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                @if (!isLocked)
                {
                    <div class="d-flex justify-content-end mt-4">
                        <button class="btn btn-primary btn-lg px-5 rounded-pill" @onclick="Kaydet" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            Kaydet
                        </button>
                    </div>
                }
            }
        </div>
    </div>
</div>

@code {
    private bool isLoading = true;
    private bool isSaving = false;
    private bool isLocked = false;
    private int currentUserId;

    private string[] gunler = { "Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma" };
    private HashSet<string> seciliSaatler = new HashSet<string>();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            var idClaim = user.FindFirst("UserId");
            if (idClaim != null && int.TryParse(idClaim.Value, out int id)) currentUserId = id;
        }

        isLocked = await DataService.IsSystemLockedAsync();

        // OKUMA İŞLEMİ: Veritabanındaki int (1) değerini string ("Pazartesi") olarak çeviriyoruz
        var mevcutVeriler = await DataService.GetOgrenciMesguliyetAsync(currentUserId);
        foreach (var item in mevcutVeriler)
        {
            string gunAdi = GunIndexiniMetneCevir(item.Gun); // Önemli Dönüşüm
            seciliSaatler.Add($"{gunAdi}-{item.Saat}");
        }

        isLoading = false;
    }

    private bool IsSelected(string gun, int saat) => seciliSaatler.Contains($"{gun}-{saat}");

    private void ToggleSlot(string gun, int saat)
    {
        if (isLocked) return;
        string key = $"{gun}-{saat}";
        if (seciliSaatler.Contains(key)) seciliSaatler.Remove(key);
        else seciliSaatler.Add(key);

        StateHasChanged();
    }

    private async Task Kaydet()
    {
        isSaving = true;
        var kayitListesi = new List<OgrenciMesguliyet>();

        foreach (var key in seciliSaatler)
        {
            var parts = key.Split('-'); // parts[0]="Pazartesi", parts[1]="9"

            kayitListesi.Add(new OgrenciMesguliyet
            {
                KullaniciID = currentUserId,
                // KAYDETME İŞLEMİ: String ("Pazartesi") değerini int (1) olarak çeviriyoruz
                Gun = GunMetniniIndexeCevir(parts[0]),
                Saat = int.Parse(parts[1])
            });
        }

        await DataService.SaveOgrenciMesguliyetAsync(currentUserId, kayitListesi);
        isSaving = false;
    }

    // YARDIMCI METODLAR (DÖNÜŞTÜRÜCÜLER)
    private int GunMetniniIndexeCevir(string gun)
    {
        return gun switch { "Pazartesi" => 1, "Salı" => 2, "Çarşamba" => 3, "Perşembe" => 4, "Cuma" => 5, _ => 1 };
    }

    private string GunIndexiniMetneCevir(int index)
    {
        return index switch { 1 => "Pazartesi", 2 => "Salı", 3 => "Çarşamba", 4 => "Perşembe", 5 => "Cuma", _ => "Pazartesi" };
    }
}